<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Watch Movie</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="css/style.css" />
</head>

<body>

<header class="top-bar">
  <a href="index.html" class="back-link">‚¨Ö Home</a>
  <h1 id="movieTitle">Loading...</h1>
  <button id="favBtn" class="btn">‚ù§Ô∏è Favorite</button>
</header>

<section class="player-section">
  <video id="videoPlayer" controls autoplay width="100%">
    <source id="videoSource" src="" type="video/mp4">
    Your browser does not support video.
  </video>
</section>

<section class="actions">
  <button class="btn" id="watchBtn">‚ñ∂ Watched</button>
  <a id="downloadBtn" class="btn" href="#" download>‚¨á Download</a>
</section>

<script>
/*************************
  GET MOVIE ID
**************************/
const params = new URLSearchParams(window.location.search);
const movieId = params.get("id");

if (!movieId) {
  alert("Invalid movie");
  location.href = "index.html";
}

/*************************
  SAMPLE MOVIE DATA
  (Later API replaceable)
**************************/
const movie = {
  id: movieId,
  title: movieId,
  video: "https://www.w3schools.com/html/mov_bbb.mp4"
};

/*************************
  SET MOVIE
**************************/
document.getElementById("movieTitle").innerText = movie.title;
document.getElementById("videoSource").src = movie.video;
document.getElementById("downloadBtn").href = movie.video;

const player = document.getElementById("videoPlayer");
player.load();

/*************************
  CONTINUE WATCHING
**************************/
const progressKey = "progress_" + movie.id;

player.addEventListener("timeupdate", () => {
  localStorage.setItem(progressKey, player.currentTime);
});

player.addEventListener("loadedmetadata", () => {
  const savedTime = localStorage.getItem(progressKey);
  if (savedTime) {
    player.currentTime = savedTime;
  }
});

/*************************
  ANALYTICS
**************************/
let analytics = JSON.parse(localStorage.getItem("clickAnalytics")) || {};

if (!analytics[movie.id]) {
  analytics[movie.id] = { watch: 0, download: 0, open: 0 };
}

document.getElementById("watchBtn").onclick = () => {
  analytics[movie.id].watch++;
  localStorage.setItem("clickAnalytics", JSON.stringify(analytics));
  alert("Watch counted ‚úÖ");
};

document.getElementById("downloadBtn").onclick = () => {
  analytics[movie.id].download++;
  localStorage.setItem("clickAnalytics", JSON.stringify(analytics));
};

/*************************
  FAVORITES
**************************/
let favorites = JSON.parse(localStorage.getItem("favorites")) || [];
const favBtn = document.getElementById("favBtn");

function updateFavBtn() {
  const exists = favorites.find(m => m.id === movie.id);
  favBtn.innerText = exists ? "üíî Remove Favorite" : "‚ù§Ô∏è Add Favorite";
}

favBtn.onclick = () => {
  const exists = favorites.find(m => m.id === movie.id);
  if (exists) {
    favorites = favorites.filter(m => m.id !== movie.id);
  } else {
    favorites.push({ id: movie.id, title: movie.title });
  }
  localStorage.setItem("favorites", JSON.stringify(favorites));
  updateFavBtn();
};

updateFavBtn();

/*************************
  RECENTLY VIEWED
**************************/
let recent = JSON.parse(localStorage.getItem("recentlyViewed")) || [];
recent = recent.filter(m => m.id !== movie.id);
recent.unshift({ id: movie.id, title: movie.title });
recent = recent.slice(0, 10);
localStorage.setItem("recentlyViewed", JSON.stringify(recent));
</script>

</body>
</html>
